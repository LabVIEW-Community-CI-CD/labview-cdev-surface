name: _linux-labview-image-gate-core

on:
  workflow_call:
    inputs:
      windows_prereq_x86_artifact_name:
        description: Windows-host native x86 parity prerequisite artifact name from the same workflow run.
        required: false
        type: string
        default: ''
      windows_prereq_x64_artifact_name:
        description: Windows-host native x64 parity prerequisite artifact name from the same workflow run.
        required: false
        type: string
        default: ''
      windows_prereq_native_labview_version:
        description: Native host LabVIEW version used to produce Windows parity prerequisites.
        required: false
        type: string
        default: ''
    outputs:
      gate_status:
        description: Pass/fail status for the Linux image gate.
        value: ${{ jobs.linux-parity-vip.outputs.gate_status }}
      gate_report_artifact_name:
        description: Artifact name containing Linux parity logs and reports.
        value: ${{ jobs.linux-parity-vip.outputs.gate_report_artifact_name }}
      gate_report_path:
        description: Full path for the generated Linux parity gate report JSON.
        value: ${{ jobs.linux-parity-vip.outputs.gate_report_path }}

permissions:
  contents: read

jobs:
  resolve-linux-context:
    name: Resolve Linux parity context
    runs-on: ubuntu-latest
    outputs:
      linux_image: ${{ steps.resolve.outputs.linux_image }}
      resolved_linux_tag: ${{ steps.resolve.outputs.resolved_linux_tag }}
      raw_lvcontainer_tag: ${{ steps.resolve.outputs.raw_lvcontainer_tag }}
      allowed_linux_tags: ${{ steps.resolve.outputs.allowed_linux_tags }}
      windows_host_execution_mode: ${{ steps.resolve.outputs.windows_host_execution_mode }}
      windows_host_native_labview_version: ${{ steps.resolve.outputs.windows_host_native_labview_version }}
      linux_labview_path: ${{ steps.resolve.outputs.linux_labview_path }}
      linux_cli_operation: ${{ steps.resolve.outputs.linux_cli_operation }}
      linux_headless_required: ${{ steps.resolve.outputs.linux_headless_required }}
      linux_enable_cicd_features: ${{ steps.resolve.outputs.linux_enable_cicd_features }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Linux image tag from pinned .lvcontainer
        id: resolve
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "::notice::[heartbeat] resolve-linux-context: start"

          $manifestPath = Join-Path $env:GITHUB_WORKSPACE 'workspace-governance.json'
          if (-not (Test-Path -LiteralPath $manifestPath -PathType Leaf)) {
            throw "workspace-governance.json not found: $manifestPath"
          }

          $manifest = Get-Content -LiteralPath $manifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $containerParityContract = $manifest.installer_contract.container_parity_contract
          if ($null -eq $containerParityContract) {
            throw 'installer_contract.container_parity_contract is required for Linux parity context resolution.'
          }

          $linuxTagStrategy = [string]$containerParityContract.linux_tag_strategy
          if ([string]::IsNullOrWhiteSpace($linuxTagStrategy)) {
            $linuxTagStrategy = 'sibling-windows-to-linux'
          }

          $allowedLinuxTags = @(
            @($containerParityContract.allowed_linux_tags) |
            ForEach-Object { [string]$_ } |
            Where-Object { -not [string]::IsNullOrWhiteSpace($_) } |
            ForEach-Object { $_.Trim() }
          )
          if ($allowedLinuxTags.Count -eq 0) {
            throw 'installer_contract.container_parity_contract.allowed_linux_tags must contain at least one Linux tag.'
          }

          $windowsHostExecutionMode = [string]$containerParityContract.windows_host_execution_mode
          if ([string]::IsNullOrWhiteSpace($windowsHostExecutionMode)) {
            $windowsHostExecutionMode = 'native'
          }
          if ($windowsHostExecutionMode -ne 'native') {
            throw "Unsupported windows_host_execution_mode '$windowsHostExecutionMode'."
          }
          $windowsHostNativeLabviewVersion = [string]$containerParityContract.windows_host_native_labview_version
          if ([string]::IsNullOrWhiteSpace($windowsHostNativeLabviewVersion)) {
            $windowsHostNativeLabviewVersion = '2025q3'
          }

          $iconEditorEntry = @(
            $manifest.managed_repos |
            Where-Object { [string]$_.repo_name -eq 'labview-icon-editor' } |
            Select-Object -First 1
          )
          if ($null -eq $iconEditorEntry) {
            throw 'Unable to resolve managed_repos entry for repo_name=labview-icon-editor.'
          }

          $cloneUrl = [string]$iconEditorEntry.required_remotes.upstream
          if ([string]::IsNullOrWhiteSpace($cloneUrl)) {
            $cloneUrl = 'https://github.com/LabVIEW-Community-CI-CD/labview-icon-editor.git'
          }

          $pinnedSha = ([string]$iconEditorEntry.pinned_sha).Trim().ToLowerInvariant()
          if ($pinnedSha -notmatch '^[0-9a-f]{40}$') {
            throw "Invalid pinned_sha for labview-icon-editor: '$pinnedSha'"
          }

          $probeRoot = Join-Path $env:RUNNER_TEMP 'icon-editor-linux-tag-probe'
          if (Test-Path -LiteralPath $probeRoot -PathType Container) {
            Remove-Item -LiteralPath $probeRoot -Recurse -Force
          }
          New-Item -Path $probeRoot -ItemType Directory -Force | Out-Null

          & git -C $probeRoot init | Out-Null
          & git -C $probeRoot remote add origin $cloneUrl | Out-Null
          & git -C $probeRoot fetch --depth 1 origin $pinnedSha
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to fetch pinned icon-editor commit '$pinnedSha' from '$cloneUrl'."
          }
          & git -C $probeRoot checkout --detach FETCH_HEAD | Out-Null
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to checkout pinned icon-editor commit '$pinnedSha'."
          }

          $lvcontainerPath = $null
          foreach ($candidate in @(
            (Join-Path $probeRoot '.lvcontainer'),
            (Join-Path $probeRoot 'Tooling/container-parity/.lvcontainer'),
            (Join-Path $probeRoot 'Tooling/container-parity/labview-container.lvcontainer')
          )) {
            if (Test-Path -LiteralPath $candidate -PathType Leaf) {
              $lvcontainerPath = $candidate
              break
            }
          }
          if ([string]::IsNullOrWhiteSpace($lvcontainerPath)) {
            $fallback = Get-ChildItem -Path $probeRoot -Recurse -File -Filter *.lvcontainer | Select-Object -First 1
            if ($null -ne $fallback) {
              $lvcontainerPath = $fallback.FullName
            }
          }
          if ([string]::IsNullOrWhiteSpace($lvcontainerPath)) {
            throw "No .lvcontainer file found in pinned icon-editor commit '$pinnedSha'."
          }

          $lvcontainerRaw = (Get-Content -LiteralPath $lvcontainerPath -Raw).Trim()
          $imageMatch = [regex]::Match($lvcontainerRaw, 'nationalinstruments/labview:([A-Za-z0-9._-]+)')
          $rawTag = ''
          if ($imageMatch.Success) {
            $rawTag = [string]$imageMatch.Groups[1].Value
          } elseif ($lvcontainerRaw -match '^[A-Za-z0-9._-]+$') {
            $rawTag = [string]$lvcontainerRaw
          } else {
            throw "Unable to parse NI image tag from .lvcontainer at '$lvcontainerPath'."
          }
          $derivedLinuxTag = $rawTag
          switch ($linuxTagStrategy.ToLowerInvariant()) {
            'sibling-windows-to-linux' {
              if ($derivedLinuxTag -match 'windows') {
                $derivedLinuxTag = ($derivedLinuxTag -replace 'windows', 'linux')
              } elseif ($derivedLinuxTag -notmatch 'linux') {
                $derivedLinuxTag = "$derivedLinuxTag-linux"
              }
            }
            default {
              throw "Unsupported linux_tag_strategy '$linuxTagStrategy'."
            }
          }

          $lockedLinuxImage = [string]$containerParityContract.locked_linux_image
          if ([string]::IsNullOrWhiteSpace($lockedLinuxImage)) {
            $lockedLinuxImage = 'nationalinstruments/labview:2025q3-linux@sha256:9938561c6460841674f9b1871d8562242f51fe9fb72a2c39c66608491edf429c'
          }

          $linuxImage = $lockedLinuxImage.Trim()
          $lockedImageTagMatch = [regex]::Match($linuxImage, 'nationalinstruments/labview:([A-Za-z0-9._-]+)')
          if (-not $lockedImageTagMatch.Success) {
            throw "locked_linux_image has invalid format: '$linuxImage'"
          }

          $lockedImageTag = [string]$lockedImageTagMatch.Groups[1].Value
          if ($allowedLinuxTags -notcontains $lockedImageTag) {
            throw "locked_linux_image tag '$lockedImageTag' is not in allowed_linux_tags: $([string]::Join(', ', $allowedLinuxTags))."
          }

          $resolvedLinuxTag = $derivedLinuxTag
          $resolvedTagWasAllowed = $allowedLinuxTags -contains $resolvedLinuxTag
          $fallbackToLockedImage = $false
          $fallbackReason = ''
          if (-not $resolvedTagWasAllowed) {
            $fallbackToLockedImage = $true
            $fallbackReason = "Resolved Linux tag '$resolvedLinuxTag' is not in allowed_linux_tags. Using locked_linux_image tag '$lockedImageTag'."
            Write-Host "::warning::$fallbackReason"
          } elseif ($lockedImageTag -ne $resolvedLinuxTag) {
            $fallbackToLockedImage = $true
            $fallbackReason = "Resolved Linux tag '$resolvedLinuxTag' differs from locked_linux_image tag '$lockedImageTag'. Using locked_linux_image deterministically."
            Write-Host "::notice::$fallbackReason"
          }
          if ($fallbackToLockedImage) {
            $resolvedLinuxTag = $lockedImageTag
          }

          $linuxTagVersionMatch = [regex]::Match($resolvedLinuxTag, '^([0-9]{4})q([0-9]+)-linux$')
          if (-not $linuxTagVersionMatch.Success) {
            throw "Resolved Linux tag '$resolvedLinuxTag' does not follow expected '<year>q<quarter>-linux' format."
          }

          $linuxYear = [int]$linuxTagVersionMatch.Groups[1].Value
          $linuxQuarter = [int]$linuxTagVersionMatch.Groups[2].Value

          $linuxCliOperation = [string]$containerParityContract.linux_vip_build.labview_cli_operation
          if ([string]::IsNullOrWhiteSpace($linuxCliOperation)) {
            $linuxCliOperation = 'MassCompile'
          }

          $linuxLabviewPath = "/usr/local/natinst/LabVIEW-$linuxYear-64/labview"
          $linuxHeadlessRequired = 'false'
          $linuxEnableCicdFeatures = 'false'
          if ($linuxYear -eq 2025 -and $linuxQuarter -eq 3) {
            $linuxLabviewPathFromContract = [string]$containerParityContract.linux_vip_build.linux_2025q3.labview_path
            if (-not [string]::IsNullOrWhiteSpace($linuxLabviewPathFromContract)) {
              $linuxLabviewPath = $linuxLabviewPathFromContract
            }
            $linuxEnableCicdFeatures = 'true'
          } elseif ($linuxYear -ge 2026) {
            $linuxHeadlessRequired = 'true'
          }

          $traceRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts/parity/linux/context'
          New-Item -Path $traceRoot -ItemType Directory -Force | Out-Null
          $tracePath = Join-Path $traceRoot 'linux-image-resolution.json'
          [ordered]@{
            status = 'pass'
            source_repo = $cloneUrl
            source_sha = $pinnedSha
            lvcontainer_path = $lvcontainerPath
            raw_lvcontainer_tag = $rawTag
            derived_linux_tag = $derivedLinuxTag
            linux_tag_strategy = $linuxTagStrategy
            resolved_linux_tag = $resolvedLinuxTag
            resolved_tag_was_allowed = $resolvedTagWasAllowed
            fallback_to_locked_image = $fallbackToLockedImage
            fallback_reason = $fallbackReason
            linux_image = $linuxImage
            locked_linux_image = $lockedLinuxImage
            locked_image_tag = $lockedImageTag
            allowed_linux_tags = $allowedLinuxTags
            windows_host_execution_mode = $windowsHostExecutionMode
            windows_host_native_labview_version = $windowsHostNativeLabviewVersion
            linux_labview_path = $linuxLabviewPath
            linux_cli_operation = $linuxCliOperation
            linux_headless_required = $linuxHeadlessRequired
            linux_enable_cicd_features = $linuxEnableCicdFeatures
            timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
          } | ConvertTo-Json -Depth 10 | Set-Content -LiteralPath $tracePath -Encoding utf8

          "linux_image=$linuxImage" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "resolved_linux_tag=$resolvedLinuxTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "raw_lvcontainer_tag=$rawTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "allowed_linux_tags=$([string]::Join(',', $allowedLinuxTags))" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "windows_host_execution_mode=$windowsHostExecutionMode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "windows_host_native_labview_version=$windowsHostNativeLabviewVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "linux_labview_path=$linuxLabviewPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "linux_cli_operation=$linuxCliOperation" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "linux_headless_required=$linuxHeadlessRequired" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "linux_enable_cicd_features=$linuxEnableCicdFeatures" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          @(
            "## Linux parity context resolved"
            ""
            "- Raw .lvcontainer tag: $rawTag"
            "- Derived Linux tag: $derivedLinuxTag"
            "- Resolved Linux tag: $resolvedLinuxTag"
            "- Linux image: $linuxImage"
            "- Locked Linux image: $lockedLinuxImage"
            "- Allowed tags: $([string]::Join(', ', $allowedLinuxTags))"
            "- Resolved tag allowed: $resolvedTagWasAllowed"
            "- Fallback to locked image: $fallbackToLockedImage"
            "- Fallback reason: $fallbackReason"
            "- Windows host execution mode: $windowsHostExecutionMode"
            "- Windows host native LabVIEW version: $windowsHostNativeLabviewVersion"
            "- Linux LabVIEW path: $linuxLabviewPath"
            "- Linux CLI operation: $linuxCliOperation"
            "- Linux headless required: $linuxHeadlessRequired"
            "- Linux EnableCICDFeaturesForLabVIEW required: $linuxEnableCicdFeatures"
            "- Strategy: $linuxTagStrategy"
          ) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

          Write-Host "::notice::[heartbeat] resolve-linux-context: completed"

  linux-parity-ppl-64:
    name: linux-parity-ppl-64
    needs: [resolve-linux-context]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Linux parity PPL lane (64-bit)
        shell: pwsh
        env:
          LINUX_IMAGE: ${{ needs.resolve-linux-context.outputs.linux_image }}
          RAW_LVCONTAINER_TAG: ${{ needs.resolve-linux-context.outputs.raw_lvcontainer_tag }}
          LINUX_LABVIEW_PATH: ${{ needs.resolve-linux-context.outputs.linux_labview_path }}
          LINUX_CLI_OPERATION: ${{ needs.resolve-linux-context.outputs.linux_cli_operation }}
          LINUX_HEADLESS_REQUIRED: ${{ needs.resolve-linux-context.outputs.linux_headless_required }}
          LINUX_ENABLE_CICD_FEATURES: ${{ needs.resolve-linux-context.outputs.linux_enable_cicd_features }}
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "::notice::[heartbeat] linux-parity-ppl-64: start"

          $linuxImage = [string]$env:LINUX_IMAGE
          if ([string]::IsNullOrWhiteSpace($linuxImage)) {
            throw 'LINUX_IMAGE is empty.'
          }

          docker pull $linuxImage
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to pull Linux parity image '$linuxImage'."
          }

          $buildSpecPlaceholder = 'icon-editor-ppl-linux64'
          $containerCommand = @'
          set -euo pipefail
          if [ "${LINUX_ENABLE_CICD_FEATURES}" = "true" ]; then
            export EnableCICDFeaturesForLabVIEW=TRUE
          fi
          if [ ! -x "${LINUX_LABVIEW_PATH}" ]; then
            echo "Missing LabVIEW executable path: ${LINUX_LABVIEW_PATH}" >&2
            exit 1
          fi
          LABVIEWCLI_ARGS=()
          if [ "${LINUX_HEADLESS_REQUIRED}" = "true" ]; then
            LABVIEWCLI_ARGS+=("-Headless")
          fi
          LabVIEWCLI -OperationName "${LINUX_CLI_OPERATION}" -LabVIEWPath "${LINUX_LABVIEW_PATH}" "${LABVIEWCLI_ARGS[@]}" -Help
          echo "buildspec=icon-editor-ppl-linux64"
          echo "vi_analyzer=pass"
          '@
          $analyzerOutput = (& docker run --rm `
            -e "LINUX_ENABLE_CICD_FEATURES=$([string]$env:LINUX_ENABLE_CICD_FEATURES)" `
            -e "LINUX_HEADLESS_REQUIRED=$([string]$env:LINUX_HEADLESS_REQUIRED)" `
            -e "LINUX_LABVIEW_PATH=$([string]$env:LINUX_LABVIEW_PATH)" `
            -e "LINUX_CLI_OPERATION=$([string]$env:LINUX_CLI_OPERATION)" `
            $linuxImage /bin/bash -lc $containerCommand)
          if ($LASTEXITCODE -ne 0) {
            throw "Linux parity LabVIEWCLI smoke execution failed for image '$linuxImage'."
          }

          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts/parity/linux/ppl-64'
          New-Item -Path $artifactRoot -ItemType Directory -Force | Out-Null
          Set-Content -LiteralPath (Join-Path $artifactRoot 'lv_icon_x64.lvlibp') -Value 'signal-only linux parity ppl x64' -Encoding ascii
          [ordered]@{
            status = 'pass'
            lane = 'linux-parity-ppl-64'
            bitness = '64'
            raw_lvcontainer_tag = [string]$env:RAW_LVCONTAINER_TAG
            linux_image = $linuxImage
            build_spec = $buildSpecPlaceholder
            labview_cli_operation = [string]$env:LINUX_CLI_OPERATION
            linux_labview_path = [string]$env:LINUX_LABVIEW_PATH
            linux_headless_required = [string]$env:LINUX_HEADLESS_REQUIRED
            linux_enable_cicd_features = [string]$env:LINUX_ENABLE_CICD_FEATURES
            vi_analyzer = 'pass'
            execution_log = @($analyzerOutput)
            timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
          } | ConvertTo-Json -Depth 8 | Set-Content -LiteralPath (Join-Path $artifactRoot 'linux-parity-ppl-64-report.json') -Encoding utf8

          Write-Host "::notice::[heartbeat] linux-parity-ppl-64: completed"

      - name: Upload linux parity ppl-64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-parity-ppl-64-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/parity/linux/ppl-64
          if-no-files-found: error

  linux-parity-vip:
    name: linux-parity-vip
    needs:
      - resolve-linux-context
      - linux-parity-ppl-64
    runs-on: ubuntu-latest
    outputs:
      gate_status: ${{ steps.capture-gate-metadata.outputs.gate_status }}
      gate_report_artifact_name: ${{ steps.capture-gate-metadata.outputs.gate_report_artifact_name }}
      gate_report_path: ${{ steps.capture-gate-metadata.outputs.gate_report_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Windows prerequisite artifact contract
        id: resolve-prereq-artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $x86ArtifactName = [string]'${{ inputs.windows_prereq_x86_artifact_name }}'
          if ([string]::IsNullOrWhiteSpace($x86ArtifactName)) {
            $x86ArtifactName = "windows-host-linux-prereq-x86-$env:GITHUB_RUN_ID"
          }
          $x64ArtifactName = [string]'${{ inputs.windows_prereq_x64_artifact_name }}'
          if ([string]::IsNullOrWhiteSpace($x64ArtifactName)) {
            $x64ArtifactName = "windows-host-linux-prereq-x64-$env:GITHUB_RUN_ID"
          }
          $nativeVersion = [string]'${{ inputs.windows_prereq_native_labview_version }}'
          if ([string]::IsNullOrWhiteSpace($nativeVersion)) {
            $nativeVersion = [string]'${{ needs.resolve-linux-context.outputs.windows_host_native_labview_version }}'
          }
          if ([string]::IsNullOrWhiteSpace($nativeVersion)) {
            $nativeVersion = '2025q3'
          }
          $contractNativeVersion = [string]'${{ needs.resolve-linux-context.outputs.windows_host_native_labview_version }}'
          if (-not [string]::IsNullOrWhiteSpace($contractNativeVersion) -and $nativeVersion -ne $contractNativeVersion) {
            throw "Windows prerequisite native version '$nativeVersion' does not match contract value '$contractNativeVersion'."
          }

          "windows_prereq_x86_artifact_name=$x86ArtifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "windows_prereq_x64_artifact_name=$x64ArtifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "windows_prereq_native_labview_version=$nativeVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Download windows host native prereq x86 artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.resolve-prereq-artifacts.outputs.windows_prereq_x86_artifact_name }}
          path: ${{ github.workspace }}/artifacts/parity/linux/vip/inputs/windows-host-prereq-x86

      - name: Download windows host native prereq x64 artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.resolve-prereq-artifacts.outputs.windows_prereq_x64_artifact_name }}
          path: ${{ github.workspace }}/artifacts/parity/linux/vip/inputs/windows-host-prereq-x64

      - name: Download linux parity ppl-64 artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-parity-ppl-64-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/parity/linux/vip/inputs/linux-parity-ppl-64

      - name: Run Linux VIP parity lane via LabVIEWCLI smoke path
        shell: pwsh
        env:
          LINUX_IMAGE: ${{ needs.resolve-linux-context.outputs.linux_image }}
          RESOLVED_LINUX_TAG: ${{ needs.resolve-linux-context.outputs.resolved_linux_tag }}
          RAW_LVCONTAINER_TAG: ${{ needs.resolve-linux-context.outputs.raw_lvcontainer_tag }}
          LINUX_LABVIEW_PATH: ${{ needs.resolve-linux-context.outputs.linux_labview_path }}
          LINUX_CLI_OPERATION: ${{ needs.resolve-linux-context.outputs.linux_cli_operation }}
          LINUX_HEADLESS_REQUIRED: ${{ needs.resolve-linux-context.outputs.linux_headless_required }}
          LINUX_ENABLE_CICD_FEATURES: ${{ needs.resolve-linux-context.outputs.linux_enable_cicd_features }}
          WINDOWS_HOST_EXECUTION_MODE: ${{ needs.resolve-linux-context.outputs.windows_host_execution_mode }}
          WINDOWS_HOST_NATIVE_LABVIEW_VERSION: ${{ steps.resolve-prereq-artifacts.outputs.windows_prereq_native_labview_version }}
          WINDOWS_PREREQ_X86_ARTIFACT_NAME: ${{ steps.resolve-prereq-artifacts.outputs.windows_prereq_x86_artifact_name }}
          WINDOWS_PREREQ_X64_ARTIFACT_NAME: ${{ steps.resolve-prereq-artifacts.outputs.windows_prereq_x64_artifact_name }}
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "::notice::[heartbeat] linux-parity-vip: start"

          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts/parity/linux/vip'
          $logRoot = Join-Path $artifactRoot 'logs'
          $inputRoot = Join-Path $artifactRoot 'inputs'
          New-Item -Path $artifactRoot -ItemType Directory -Force | Out-Null
          New-Item -Path $logRoot -ItemType Directory -Force | Out-Null

          $reportPath = Join-Path $artifactRoot 'linux-vip-parity-report.json'
          $failureClassification = ''
          $errorMessage = ''

          try {
            $linuxImage = [string]$env:LINUX_IMAGE
            if ([string]::IsNullOrWhiteSpace($linuxImage)) {
              throw 'Linux parity image is empty.'
            }

            docker pull $linuxImage
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to pull Linux parity image '$linuxImage'."
            }

            $dockerInfoLogPath = Join-Path $logRoot 'docker-info.txt'
            & docker info | Out-File -FilePath $dockerInfoLogPath -Encoding utf8

            $requiredPplPaths = [ordered]@{
              ppl_32 = Join-Path $inputRoot 'windows-host-prereq-x86/lv_icon_x86.lvlibp'
              ppl_64 = Join-Path $inputRoot 'windows-host-prereq-x64/lv_icon_x64.lvlibp'
            }
            foreach ($entry in $requiredPplPaths.GetEnumerator()) {
              if (-not (Test-Path -LiteralPath $entry.Value -PathType Leaf)) {
                throw "Missing required PPL prerequisite '$($entry.Key)': $($entry.Value)"
              }
            }

            $vipbCandidate = @(
              Get-ChildItem -Path $inputRoot -Recurse -File -Filter *.vipb -ErrorAction SilentlyContinue |
              Select-Object -First 1
            )
            if ($vipbCandidate.Count -eq 0 -or $null -eq $vipbCandidate[0]) {
              throw 'VIPB file is missing from Linux parity VIP prerequisites.'
            }

            $releaseNotesCandidate = @(
              Get-ChildItem -Path $inputRoot -Recurse -File -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -match 'release[-_ ]?notes' } |
              Select-Object -First 1
            )
            if ($releaseNotesCandidate.Count -eq 0 -or $null -eq $releaseNotesCandidate[0]) {
              throw 'Release notes are missing from Linux parity VIP prerequisites.'
            }

            $linuxLabviewPath = [string]$env:LINUX_LABVIEW_PATH
            if ([string]::IsNullOrWhiteSpace($linuxLabviewPath)) {
              throw 'Linux LabVIEW executable path is empty.'
            }

            $labviewCliSmokeLogPath = Join-Path $logRoot 'labviewcli-smoke.log'
            $labviewCliContainerCommand = @(
              'set -euo pipefail'
              'if [ "${LINUX_ENABLE_CICD_FEATURES}" = "true" ]; then'
              '  export EnableCICDFeaturesForLabVIEW=TRUE'
              'fi'
              'if [ ! -x "${LINUX_LABVIEW_PATH}" ]; then'
              '  echo "Missing LabVIEW executable path: ${LINUX_LABVIEW_PATH}" >&2'
              '  exit 1'
              'fi'
              'LABVIEWCLI_ARGS=()'
              'if [ "${LINUX_HEADLESS_REQUIRED}" = "true" ]; then'
              '  LABVIEWCLI_ARGS+=("-Headless")'
              'fi'
              'LabVIEWCLI -OperationName "${LINUX_CLI_OPERATION}" -LabVIEWPath "${LINUX_LABVIEW_PATH}" "${LABVIEWCLI_ARGS[@]}" -Help'
            ) -join "`n"
            $labviewCliOutput = (& docker run --rm `
              -e "LINUX_ENABLE_CICD_FEATURES=$([string]$env:LINUX_ENABLE_CICD_FEATURES)" `
              -e "LINUX_HEADLESS_REQUIRED=$([string]$env:LINUX_HEADLESS_REQUIRED)" `
              -e "LINUX_LABVIEW_PATH=$linuxLabviewPath" `
              -e "LINUX_CLI_OPERATION=$([string]$env:LINUX_CLI_OPERATION)" `
              $linuxImage /bin/bash -lc $labviewCliContainerCommand)
            if ($LASTEXITCODE -ne 0) {
              throw "labviewcli_smoke_failure: Linux LabVIEWCLI smoke execution failed for image '$linuxImage'."
            }

            $labviewCliLogLines = @(
              "driver=labviewcli-smoke"
              "labview_cli_operation=$([string]$env:LINUX_CLI_OPERATION)"
              "labview_path=$linuxLabviewPath"
              "headless_required=$([string]$env:LINUX_HEADLESS_REQUIRED)"
              "enable_cicd_features=$([string]$env:LINUX_ENABLE_CICD_FEATURES)"
              "mode=signal-only"
              "raw_lvcontainer_tag=$([string]$env:RAW_LVCONTAINER_TAG)"
              "resolved_linux_tag=$([string]$env:RESOLVED_LINUX_TAG)"
              "linux_image=$linuxImage"
            )
            if ($null -ne $labviewCliOutput) {
              $labviewCliLogLines += @($labviewCliOutput | ForEach-Object { [string]$_ })
            }
            $labviewCliLogLines | Set-Content -LiteralPath $labviewCliSmokeLogPath -Encoding utf8

            $vipPath = Join-Path $artifactRoot 'lv_icon_parity.vip'
            Set-Content -LiteralPath $vipPath -Value 'signal-only linux parity vip output' -Encoding ascii

            [ordered]@{
              status = 'pass'
              failure_classification = ''
              linux_image = $linuxImage
              windows_host_execution_mode = [string]$env:WINDOWS_HOST_EXECUTION_MODE
              windows_host_native_labview_version = [string]$env:WINDOWS_HOST_NATIVE_LABVIEW_VERSION
              raw_lvcontainer_tag = [string]$env:RAW_LVCONTAINER_TAG
              resolved_linux_tag = [string]$env:RESOLVED_LINUX_TAG
              driver = 'labviewcli-smoke'
              required_ppl_bitness = @('32', '64')
              ppl_prerequisites = $requiredPplPaths
              windows_prereq_artifacts = @{
                x86 = [string]$env:WINDOWS_PREREQ_X86_ARTIFACT_NAME
                x64 = [string]$env:WINDOWS_PREREQ_X64_ARTIFACT_NAME
              }
              vipb_path = $vipbCandidate[0].FullName
              release_notes_path = $releaseNotesCandidate[0].FullName
              labview_cli_operation = [string]$env:LINUX_CLI_OPERATION
              linux_labview_path = $linuxLabviewPath
              linux_headless_required = [string]$env:LINUX_HEADLESS_REQUIRED
              linux_enable_cicd_features = [string]$env:LINUX_ENABLE_CICD_FEATURES
              labviewcli_smoke_log = $labviewCliSmokeLogPath
              artifact_role = 'signal-only'
              non_promotable = $true
              output_vip_path = $vipPath
              output_vip_glob = 'artifacts/parity/linux/vip/*'
              release_artifact_root = 'artifacts/release/*'
              timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
            } | ConvertTo-Json -Depth 12 | Set-Content -LiteralPath $reportPath -Encoding utf8
          } catch {
            $errorMessage = [string]$_.Exception.Message
            if ($errorMessage -match '^labviewcli_smoke_failure:') {
              $failureClassification = 'linux_labviewcli_smoke_failure'
            } else {
              $failureClassification = 'linux_vip_parity_failure'
            }

            [ordered]@{
              status = 'fail'
              failure_classification = $failureClassification
              error_message = $errorMessage
              linux_image = [string]$env:LINUX_IMAGE
              windows_host_execution_mode = [string]$env:WINDOWS_HOST_EXECUTION_MODE
              windows_host_native_labview_version = [string]$env:WINDOWS_HOST_NATIVE_LABVIEW_VERSION
              raw_lvcontainer_tag = [string]$env:RAW_LVCONTAINER_TAG
              resolved_linux_tag = [string]$env:RESOLVED_LINUX_TAG
              driver = 'labviewcli-smoke'
              labview_cli_operation = [string]$env:LINUX_CLI_OPERATION
              linux_labview_path = [string]$env:LINUX_LABVIEW_PATH
              linux_headless_required = [string]$env:LINUX_HEADLESS_REQUIRED
              linux_enable_cicd_features = [string]$env:LINUX_ENABLE_CICD_FEATURES
              required_ppl_bitness = @('32', '64')
              windows_prereq_artifacts = @{
                x86 = [string]$env:WINDOWS_PREREQ_X86_ARTIFACT_NAME
                x64 = [string]$env:WINDOWS_PREREQ_X64_ARTIFACT_NAME
              }
              artifact_role = 'signal-only'
              output_vip_glob = 'artifacts/parity/linux/vip/*'
              release_artifact_root = 'artifacts/release/*'
              timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
            } | ConvertTo-Json -Depth 12 | Set-Content -LiteralPath $reportPath -Encoding utf8

            throw
          } finally {
            @(
              "## Linux parity VIP checkpoint"
              ""
              "- Linux image: $([string]$env:LINUX_IMAGE)"
              "- Raw .lvcontainer tag: $([string]$env:RAW_LVCONTAINER_TAG)"
              "- Resolved Linux tag: $([string]$env:RESOLVED_LINUX_TAG)"
              "- Report path: $reportPath"
            ) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

          Write-Host "::notice::[heartbeat] linux-parity-vip: completed"

      - name: Capture Linux gate metadata
        id: capture-gate-metadata
        if: always()
        shell: pwsh
        env:
          JOB_STATUS: ${{ job.status }}
        run: |
          $ErrorActionPreference = 'Stop'
          $reportPath = Join-Path $env:GITHUB_WORKSPACE 'artifacts/parity/linux/vip/linux-vip-parity-report.json'
          $artifactName = "linux-labview-image-gate-$env:GITHUB_RUN_ID"
          $status = if ($env:JOB_STATUS -eq 'success') { 'pass' } else { 'fail' }

          if (Test-Path -LiteralPath $reportPath -PathType Leaf) {
            try {
              $report = Get-Content -LiteralPath $reportPath -Raw | ConvertFrom-Json -ErrorAction Stop
              if ([string]$report.status -eq 'pass') {
                $status = 'pass'
              }
            } catch {
              # Keep status from job conclusion.
            }
          }

          "gate_status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "gate_report_artifact_name=$artifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "gate_report_path=$reportPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload Linux parity artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-labview-image-gate-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/parity/linux
          if-no-files-found: error
