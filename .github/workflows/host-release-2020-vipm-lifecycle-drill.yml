name: host-release-2020-vipm-lifecycle-drill

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Optional branch or SHA to evaluate. Defaults to current workflow ref.
        required: false
        type: string
      selected_ppl_bitness:
        description: PPL gate bitness to enforce before VIPM lifecycle check (32 or 64).
        required: false
        default: '64'
        type: string
      keep_smoke_workspace:
        description: Keep smoke workspace on runner for post-mortem troubleshooting.
        required: false
        default: false
        type: boolean
      allow_system_account:
        description: Allow running on NT AUTHORITY\\SYSTEM for diagnostic-only execution.
        required: false
        default: false
        type: boolean
      nsis_root:
        description: Optional NSIS root override. Defaults to repository variable NSIS_ROOT or C:\Program Files (x86)\NSIS.
        required: false
        default: ''
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: host-release-2020-vipm-lifecycle-drill-${{ github.ref }}
  cancel-in-progress: false

jobs:
  host-release-2020-vipm-lifecycle-drill:
    name: Host Release 2020 VIPM Lifecycle Drill
    runs-on: [self-hosted, windows, self-hosted-windows-lv, installer-harness]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve workflow_dispatch ref override
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ref != '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          & git fetch --prune origin "${{ inputs.ref }}"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to fetch requested ref '${{ inputs.ref }}'."
          }

          & git checkout --force FETCH_HEAD
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to checkout requested ref '${{ inputs.ref }}'."
          }

      - name: Assert machine preflight pack
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $reportPath = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-machine-preflight.json'
          $allowSystemAccountText = [string]'${{ inputs.allow_system_account }}'
          $allowSystemAccount = $false
          if (-not [string]::IsNullOrWhiteSpace($allowSystemAccountText)) {
            try {
              $allowSystemAccount = [System.Convert]::ToBoolean($allowSystemAccountText)
            } catch {
              throw "allow_system_account must be boolean. actual='$allowSystemAccountText'"
            }
          }

          $preflightArgs = @(
            '-NoProfile',
            '-File', './scripts/Assert-InstallerHarnessMachinePreflight.ps1',
            '-ExpectedLabviewYear', '2020',
            '-DockerContext', 'desktop-linux',
            '-DockerCheckSeverity', 'warning',
            '-OutputPath', $reportPath
          )
          if (-not $allowSystemAccount) {
            $preflightArgs += '-RequireNonSystemAccount'
          }

          & pwsh @preflightArgs
          if ($LASTEXITCODE -ne 0) {
            if (Test-Path -LiteralPath $reportPath -PathType Leaf) {
              Get-Content -LiteralPath $reportPath -Raw | Write-Host
            }
            throw "Machine preflight checks failed."
          }

      - name: Execute host-release 2020 VIPM lifecycle drill
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $reportPath = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-lifecycle-drill-report.json'
          $iterationRoot = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-lifecycle'
          $smokeRoot = Join-Path $env:RUNNER_TEMP 'dev-smoke-lvie-2020'

          $selectedPplBitnessText = [string]'${{ inputs.selected_ppl_bitness }}'
          if ([string]::IsNullOrWhiteSpace($selectedPplBitnessText)) {
            $selectedPplBitnessText = '64'
          }
          if ($selectedPplBitnessText -notin @('32', '64')) {
            throw "selected_ppl_bitness must be 32 or 64. actual='$selectedPplBitnessText'"
          }

          $keepSmokeWorkspace = $false
          $keepSmokeWorkspaceText = [string]'${{ inputs.keep_smoke_workspace }}'
          if (-not [string]::IsNullOrWhiteSpace($keepSmokeWorkspaceText)) {
            try {
              $keepSmokeWorkspace = [System.Convert]::ToBoolean($keepSmokeWorkspaceText)
            } catch {
              throw "keep_smoke_workspace must be boolean. actual='$keepSmokeWorkspaceText'"
            }
          }

          $nsisRootInput = [string]'${{ inputs.nsis_root }}'
          $nsisRootValue = if (-not [string]::IsNullOrWhiteSpace($nsisRootInput)) { $nsisRootInput } elseif (-not [string]::IsNullOrWhiteSpace([string]::Concat('${{ vars.NSIS_ROOT }}'))) { '${{ vars.NSIS_ROOT }}' } else { 'C:\Program Files (x86)\NSIS' }

          $invokeArgs = @(
            '-NoProfile',
            '-File', './scripts/Invoke-HostRelease2020VipmLifecycleDrill.ps1',
            '-OutputPath', $reportPath,
            '-IterationOutputRoot', $iterationRoot,
            '-SmokeWorkspaceRoot', $smokeRoot,
            '-SelectedPplBitness', $selectedPplBitnessText,
            '-TargetLabviewYear', '2020',
            '-TargetVipmBitness', '64',
            '-NsisRoot', $nsisRootValue
          )
          if ($keepSmokeWorkspace) {
            $invokeArgs += '-KeepSmokeWorkspace'
          }

          & pwsh @invokeArgs
          if ($LASTEXITCODE -ne 0) {
            if (Test-Path -LiteralPath $reportPath -PathType Leaf) {
              Get-Content -LiteralPath $reportPath -Raw | Write-Host
            }
            throw "Host-release 2020 VIPM lifecycle drill failed."
          }

      - name: Prepare host-release 2020 VIPM lifecycle artifact bundle
        if: always()
        id: prepare_host_release_bundle
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          function Copy-PathIfExists {
            param(
              [Parameter(Mandatory = $true)][string]$SourcePath,
              [Parameter(Mandatory = $true)][string]$BundleRoot,
              [Parameter(Mandatory = $true)][string]$RelativePath,
              [Parameter(Mandatory = $true)][ref]$IncludedPaths,
              [Parameter(Mandatory = $true)][ref]$MissingPaths
            )

            if (-not (Test-Path -LiteralPath $SourcePath)) {
              $MissingPaths.Value += $SourcePath
              return
            }

            $targetPath = Join-Path $BundleRoot $RelativePath
            $targetParent = Split-Path -Parent $targetPath
            if (-not [string]::IsNullOrWhiteSpace($targetParent) -and -not (Test-Path -LiteralPath $targetParent -PathType Container)) {
              New-Item -ItemType Directory -Path $targetParent -Force | Out-Null
            }

            if (Test-Path -LiteralPath $SourcePath -PathType Container) {
              Copy-Item -LiteralPath $SourcePath -Destination $targetPath -Recurse -Force
            } else {
              Copy-Item -LiteralPath $SourcePath -Destination $targetPath -Force
            }
            $IncludedPaths.Value += $SourcePath
          }

          $bundleRoot = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-lifecycle-drill-bundle'
          if (Test-Path -LiteralPath $bundleRoot -PathType Container) {
            Remove-Item -LiteralPath $bundleRoot -Recurse -Force
          }
          New-Item -ItemType Directory -Path $bundleRoot -Force | Out-Null

          $reportPath = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-lifecycle-drill-report.json'
          $preflightPath = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-machine-preflight.json'
          $iterationRoot = Join-Path $env:RUNNER_TEMP 'host-release-2020-vipm-lifecycle'
          $smokeRoot = Join-Path $env:RUNNER_TEMP 'dev-smoke-lvie-2020'

          $includedPaths = @()
          $missingPaths = @()

          Copy-PathIfExists -SourcePath $reportPath -BundleRoot $bundleRoot -RelativePath 'host-release-2020-vipm-lifecycle-drill-report.json' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath $preflightPath -BundleRoot $bundleRoot -RelativePath 'host-release-2020-vipm-machine-preflight.json' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath $iterationRoot -BundleRoot $bundleRoot -RelativePath 'host-release-2020-vipm-lifecycle' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath (Join-Path $smokeRoot 'artifacts/workspace-install-latest.json') -BundleRoot $bundleRoot -RelativePath 'dev-smoke-lvie-2020/artifacts/workspace-install-latest.json' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath (Join-Path $smokeRoot 'labview-icon-editor/builds/status/workspace-installer-vip-build.json') -BundleRoot $bundleRoot -RelativePath 'dev-smoke-lvie-2020/labview-icon-editor/builds/status/workspace-installer-vip-build.json' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath (Join-Path $smokeRoot 'labview-icon-editor/builds/logs/vipm-build.log') -BundleRoot $bundleRoot -RelativePath 'dev-smoke-lvie-2020/labview-icon-editor/builds/logs/vipm-build.log' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)
          Copy-PathIfExists -SourcePath (Join-Path $smokeRoot 'labview-icon-editor/builds/logs/vipm') -BundleRoot $bundleRoot -RelativePath 'dev-smoke-lvie-2020/labview-icon-editor/builds/logs/vipm' -IncludedPaths ([ref]$includedPaths) -MissingPaths ([ref]$missingPaths)

          $manifestPath = Join-Path $bundleRoot 'artifact-manifest.json'
          [ordered]@{
            schema_version = '1.0'
            generated_at_utc = (Get-Date).ToUniversalTime().ToString('o')
            run_id = '${{ github.run_id }}'
            run_attempt = '${{ github.run_attempt }}'
            branch = '${{ github.ref_name }}'
            included_paths = @($includedPaths)
            missing_paths = @($missingPaths)
          } | ConvertTo-Json -Depth 20 | Set-Content -LiteralPath $manifestPath -Encoding utf8

          "bundle_root=$bundleRoot" >> $env:GITHUB_OUTPUT
          Get-Content -LiteralPath $manifestPath -Raw | Write-Host

      - name: Upload host-release 2020 VIPM lifecycle artifacts (primary)
        if: always()
        id: upload_host_release_primary
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: host-release-2020-vipm-lifecycle-drill-report-${{ github.run_id }}
          path: ${{ steps.prepare_host_release_bundle.outputs.bundle_root }}
          if-no-files-found: error

      - name: Upload host-release 2020 VIPM lifecycle artifacts (retry)
        if: always() && steps.upload_host_release_primary.outcome == 'failure'
        id: upload_host_release_retry
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: host-release-2020-vipm-lifecycle-drill-report-${{ github.run_id }}-retry-${{ github.run_attempt }}
          path: ${{ steps.prepare_host_release_bundle.outputs.bundle_root }}
          if-no-files-found: error

      - name: Assert host-release artifact upload completed
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $primaryOutcome = [string]'${{ steps.upload_host_release_primary.outcome }}'
          $retryOutcome = [string]'${{ steps.upload_host_release_retry.outcome }}'
          if ($primaryOutcome -ne 'success' -and $retryOutcome -ne 'success') {
            throw "Artifact upload failed on primary and retry attempts."
          }
