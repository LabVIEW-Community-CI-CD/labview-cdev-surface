name: Integration Gate

on:
  push:
    branches:
      - main
      - integration/**
  pull_request:
    branches:
      - main
      - integration/**
  workflow_dispatch:
    inputs:
      ref:
        description: Branch or SHA to evaluate. Defaults to the triggering SHA.
        required: false
        type: string

permissions:
  contents: read

jobs:
  integration-gate:
    name: Integration Gate
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate required status contexts for integration SHA
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          TARGET_REPOSITORY: ${{ github.repository }}
          INPUT_REF: ${{ inputs.ref }}
          TRIGGER_SHA: ${{ github.sha }}
          EVENT_NAME: ${{ github.event_name }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          $ErrorActionPreference = 'Stop'

          $repo = [string]$env:TARGET_REPOSITORY
          if ([string]::IsNullOrWhiteSpace($repo)) {
            throw 'TARGET_REPOSITORY was not provided.'
          }

          $targetRef = [string]$env:INPUT_REF
          $sha = ''
          if ([string]::IsNullOrWhiteSpace($targetRef)) {
            if ([string]$env:EVENT_NAME -eq 'pull_request') {
              $sha = ([string]$env:PR_HEAD_SHA).Trim().ToLowerInvariant()
            } else {
              $sha = ([string]$env:TRIGGER_SHA).Trim().ToLowerInvariant()
            }
          } else {
            $sha = (& gh api "repos/$repo/commits/$targetRef" --jq '.sha').Trim().ToLowerInvariant()
          }

          if ($sha -notmatch '^[0-9a-f]{40}$') {
            throw "Unable to resolve target SHA. ref='$targetRef' resolved='$sha'"
          }

          $requiredContexts = @(
            'CI Pipeline',
            'Workspace Installer Contract',
            'Reproducibility Contract',
            'Provenance Contract',
            'Release Race Hardening Drill'
          )

          $pollSeconds = 20
          $timeoutSeconds = 3600
          $deadline = (Get-Date).ToUniversalTime().AddSeconds($timeoutSeconds)

          while ((Get-Date).ToUniversalTime() -lt $deadline) {
            $checksJson = & gh api "repos/$repo/commits/$sha/check-runs?per_page=100"
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to read commit check-runs for '$repo' @ '$sha'."
            }

            $checksObject = $checksJson | ConvertFrom-Json -ErrorAction Stop
            $latestByContext = @{}
            $orderedChecks = @(
              @($checksObject.check_runs) |
                Sort-Object -Property @{ Expression = {
                  if ([string]::IsNullOrWhiteSpace([string]$_.started_at)) {
                    [DateTimeOffset]::MinValue
                  } else {
                    [DateTimeOffset]::Parse([string]$_.started_at).ToUniversalTime()
                  }
                }; Descending = $true }
            )

            foreach ($check in @($orderedChecks)) {
              $context = [string]$check.name
              if ([string]::IsNullOrWhiteSpace($context)) {
                continue
              }
              if (-not $latestByContext.ContainsKey($context)) {
                $latestByContext[$context] = $check
              }
            }

            $allResolved = $true
            $hasFailure = $false
            $stateSummary = @()
            foreach ($context in $requiredContexts) {
              if (-not $latestByContext.ContainsKey($context)) {
                $stateSummary += "$context=missing"
                $allResolved = $false
                continue
              }

              $check = $latestByContext[$context]
              $status = [string]$check.status
              $conclusion = [string]$check.conclusion
              $stateSummary += "$context=$status/$conclusion"

              if ($status -ne 'completed') {
                $allResolved = $false
                continue
              }

              switch ($conclusion) {
                'success' {}
                'neutral' {}
                'skipped' {}
                'failure' { $hasFailure = $true }
                'cancelled' { $hasFailure = $true }
                'timed_out' { $hasFailure = $true }
                'action_required' { $hasFailure = $true }
                'startup_failure' { $hasFailure = $true }
                'stale' { $hasFailure = $true }
                default { $allResolved = $false }
              }
            }

            Write-Host ("Required context states for {0}: {1}" -f $sha, ($stateSummary -join ', '))

            if ($hasFailure) {
              throw ("Integration gate failed for {0}. {1}" -f $sha, ($stateSummary -join ', '))
            }
            if ($allResolved) {
              Write-Host ("Integration gate passed for {0}." -f $sha)
              exit 0
            }

            Start-Sleep -Seconds $pollSeconds
          }

          throw ("Integration gate timed out after {0} seconds waiting for required contexts on {1}." -f $timeoutSeconds, $sha)
