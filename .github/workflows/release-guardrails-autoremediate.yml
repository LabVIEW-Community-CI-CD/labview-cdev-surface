name: release-guardrails-autoremediate

on:
  schedule:
    - cron: '25 * * * *'
  workflow_dispatch:
    inputs:
      race_gate_max_age_hours:
        description: Maximum age of latest successful release race-hardening drill run.
        required: false
        default: '168'
        type: string
      auto_self_heal:
        description: Apply bounded autonomous remediation actions.
        required: false
        default: true
        type: boolean
      max_attempts:
        description: Maximum remediation attempts.
        required: false
        default: '1'
        type: string
      drill_watch_timeout_minutes:
        description: Timeout minutes while watching release race-hardening drill remediation run.
        required: false
        default: '120'
        type: string

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  release-guardrails-autoremediate:
    name: Release Guardrails Auto-Remediation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Execute release guardrails auto-remediation
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_BOT_TOKEN != '' && secrets.WORKFLOW_BOT_TOKEN || github.token }}
        run: |
          $ErrorActionPreference = 'Stop'
          $reportPath = Join-Path $env:RUNNER_TEMP 'release-guardrails-autoremediate-report.json'

          $raceGateMaxAgeText = [string]'${{ inputs.race_gate_max_age_hours }}'
          $raceGateMaxAgeHours = 168
          if (-not [string]::IsNullOrWhiteSpace($raceGateMaxAgeText)) {
            $parsedRaceGateMaxAge = 0
            if (-not [int]::TryParse($raceGateMaxAgeText, [ref]$parsedRaceGateMaxAge)) {
              throw "race_gate_max_age_hours must be an integer. actual='$raceGateMaxAgeText'"
            }
            $raceGateMaxAgeHours = $parsedRaceGateMaxAge
          }

          $maxAttemptsText = [string]'${{ inputs.max_attempts }}'
          $maxAttempts = 1
          if (-not [string]::IsNullOrWhiteSpace($maxAttemptsText)) {
            $parsedMaxAttempts = 0
            if (-not [int]::TryParse($maxAttemptsText, [ref]$parsedMaxAttempts)) {
              throw "max_attempts must be an integer. actual='$maxAttemptsText'"
            }
            $maxAttempts = $parsedMaxAttempts
          }

          $watchTimeoutText = [string]'${{ inputs.drill_watch_timeout_minutes }}'
          $watchTimeoutMinutes = 120
          if (-not [string]::IsNullOrWhiteSpace($watchTimeoutText)) {
            $parsedWatchTimeout = 0
            if (-not [int]::TryParse($watchTimeoutText, [ref]$parsedWatchTimeout)) {
              throw "drill_watch_timeout_minutes must be an integer. actual='$watchTimeoutText'"
            }
            $watchTimeoutMinutes = $parsedWatchTimeout
          }

          $autoSelfHealText = [string]'${{ inputs.auto_self_heal }}'
          $autoSelfHeal = $true
          if (-not [string]::IsNullOrWhiteSpace($autoSelfHealText)) {
            $autoSelfHeal = [System.Convert]::ToBoolean($autoSelfHealText)
          }

          & pwsh -NoProfile -File ./scripts/Invoke-ReleaseGuardrailsSelfHealing.ps1 `
            -Repository '${{ github.repository }}' `
            -Branch 'main' `
            -RaceGateMaxAgeHours $raceGateMaxAgeHours `
            -AutoSelfHeal:$autoSelfHeal `
            -MaxAttempts $maxAttempts `
            -DrillWatchTimeoutMinutes $watchTimeoutMinutes `
            -OutputPath $reportPath

      - name: Upload release guardrails auto-remediation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-guardrails-autoremediate-report-${{ github.run_id }}
          path: ${{ runner.temp }}/release-guardrails-autoremediate-report.json
          if-no-files-found: error

      - name: Update release guardrails incident issue on failure
        if: failure()
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_BOT_TOKEN != '' && secrets.WORKFLOW_BOT_TOKEN || github.token }}
          REPOSITORY: ${{ github.repository }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          $ErrorActionPreference = 'Stop'
          $title = 'Release Guardrails Auto-Remediation Alert'
          $reportPath = Join-Path $env:RUNNER_TEMP 'release-guardrails-autoremediate-report.json'
          if (-not (Test-Path -LiteralPath $reportPath -PathType Leaf)) {
            throw "release guardrails report missing: $reportPath"
          }

          $report = Get-Content -LiteralPath $reportPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $body = @"
          Release guardrails auto-remediation failed.

          - Run: $env:RUN_URL
          - Reason code: $($report.reason_code)
          - Message: $($report.message)
          - Repository: $($report.repository)
          - Branch: $($report.branch)
          "@

          & pwsh -NoProfile -File ./scripts/Invoke-OpsIncidentLifecycle.ps1 `
            -Repository $env:REPOSITORY `
            -IssueTitle $title `
            -Mode Fail `
            -RunUrl $env:RUN_URL `
            -Body $body

      - name: Close release guardrails incident issue on recovery
        if: success()
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_BOT_TOKEN != '' && secrets.WORKFLOW_BOT_TOKEN || github.token }}
          REPOSITORY: ${{ github.repository }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          $ErrorActionPreference = 'Stop'
          $title = 'Release Guardrails Auto-Remediation Alert'
          $reportPath = Join-Path $env:RUNNER_TEMP 'release-guardrails-autoremediate-report.json'
          if (-not (Test-Path -LiteralPath $reportPath -PathType Leaf)) {
            throw "release guardrails report missing: $reportPath"
          }

          $report = Get-Content -LiteralPath $reportPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $body = @"
          Release guardrails auto-remediation recovered.

          - Run: $env:RUN_URL
          - Reason code: $($report.reason_code)
          - Message: $($report.message)
          - Repository: $($report.repository)
          - Branch: $($report.branch)
          "@

          & pwsh -NoProfile -File ./scripts/Invoke-OpsIncidentLifecycle.ps1 `
            -Repository $env:REPOSITORY `
            -IssueTitle $title `
            -Mode Recover `
            -RunUrl $env:RUN_URL `
            -Body $body
